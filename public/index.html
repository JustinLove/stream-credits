<!DOCTYPE HTML>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Stream Credits</title>
  <!--link href="style.css" rel="stylesheet" /-->
  <script type="text/javascript" src="stream-credits.js"></script>
</head>

<body>
</body>

<script type="text/javascript">
var app = Elm.StreamCredits.init()

var connections = []
var nextid = 0

if (app.ports.webSocketConnect) {
  app.ports.webSocketConnect.subscribe(function(address) {
    var ws = new WebSocket(address)

    ws.id = nextid++
    connections.push(ws)

    ws.onerror = function(error) {
      console.log('js websocket error', arguments)
      app.ports.webSocketReceive.send({kind: "error", id: ws.id, error: error})
    }

    ws.onopen = function() {
      //console.log('js websocket opened')
      app.ports.webSocketReceive.send({kind: "open", id: ws.id, url: address})
    }

    ws.onclose = function() {
      //console.log('js websocket closed')
      app.ports.webSocketReceive.send({kind: "close", id: ws.id, url: address})
      var index = connections.indexOf(ws)
      if (index > -1) connections.splice(index, 1)
    }

    ws.onmessage = function(message) {
      //console.log('js message', message)
      app.ports.webSocketReceive.send({kind: "message", id: ws.id, message: message.data})
    }
  })
}

if (app.ports.webSocketSend) {
  app.ports.webSocketSend.subscribe(function(args) {
    var id = args[0]
    var data = args[1]
    connections.forEach(function(ws) {
      if (ws.id == id) {
        //console.log(id, data)
        ws.send(data)
      }
    })
  })
}

if (window.obsstudio
    && app.ports.obsStudioOnVisibilityChange) {
  window.obsstudio.onActiveChange = function(visible) {
    app.ports.obsStudioOnVisibilityChange.send(visible)
  }
}

</script>

</html>

